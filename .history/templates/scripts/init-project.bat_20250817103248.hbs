@echo off
REM Script d'initialisation automatique pour {{project.name}} (Windows)
REM Usage: init-project.bat [environment]
REM Exemple: init-project.bat dev

setlocal enabledelayedexpansion

REM Configuration
set PROJECT_NAME={{project.name}}
set FRONTEND_DIR=frontend
set BACKEND_DIR=backend
set DEFAULT_ENVIRONMENT=dev

REM VÃ©rifier les arguments
if "%1"=="" (
    set ENVIRONMENT=%DEFAULT_ENVIRONMENT%
) else (
    set ENVIRONMENT=%1
)

REM Validation de l'environnement
if not "%ENVIRONMENT%"=="dev" if not "%ENVIRONMENT%"=="staging" if not "%ENVIRONMENT%"=="prod" (
    echo âŒ Environnement invalide: %ENVIRONMENT%
    echo Environnements valides: dev, staging, prod
    exit /b 1
)

REM VÃ©rifier que nous sommes dans le bon rÃ©pertoire
if not exist "%FRONTEND_DIR%" (
    echo âŒ RÃ©pertoire %FRONTEND_DIR% non trouvÃ©
    echo Assurez-vous d'exÃ©cuter ce script depuis la racine du projet gÃ©nÃ©rÃ©
    exit /b 1
)

if not exist "%BACKEND_DIR%" (
    echo âŒ RÃ©pertoire %BACKEND_DIR% non trouvÃ©
    echo Assurez-vous d'exÃ©cuter ce script depuis la racine du projet gÃ©nÃ©rÃ©
    exit /b 1
)

echo ğŸš€ Initialisation automatique de %PROJECT_NAME%
echo ğŸ“ Environnement: %ENVIRONMENT%
echo.

REM Ã‰tape 1: Installation des dÃ©pendances frontend
echo â„¹ï¸  Ã‰tape 1/4: Installation des dÃ©pendances frontend...
cd "%FRONTEND_DIR%"

if not exist "package.json" (
    echo âŒ package.json non trouvÃ© dans %FRONTEND_DIR%
    exit /b 1
)

echo â„¹ï¸  Installation des dÃ©pendances npm...
call npm install

if %ERRORLEVEL% neq 0 (
    echo âŒ Ã‰chec de l'installation des dÃ©pendances frontend
    exit /b 1
)

echo âœ… DÃ©pendances frontend installÃ©es avec succÃ¨s
cd ..

REM Ã‰tape 2: VÃ©rification de Firebase CLI
echo â„¹ï¸  Ã‰tape 2/4: VÃ©rification de Firebase CLI...

firebase --version >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo âŒ Firebase CLI non installÃ©
    echo Installez-le avec: npm install -g firebase-tools
    exit /b 1
)

for /f "tokens=*" %%i in ('firebase --version') do set FIREBASE_VERSION=%%i
echo âœ… Firebase CLI dÃ©tectÃ©: !FIREBASE_VERSION!

REM Ã‰tape 3: Configuration Firebase
echo â„¹ï¸  Ã‰tape 3/4: Configuration Firebase...

cd "%BACKEND_DIR%"

REM VÃ©rifier la connexion Firebase
echo â„¹ï¸  VÃ©rification de la connexion Firebase...
firebase projects:list >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo âš ï¸  Utilisateur Firebase non connectÃ©
    echo â„¹ï¸  Connexion Ã  Firebase...
    firebase login
)

REM VÃ©rifier que le projet existe
for /f "tokens=2 delims=:," %%i in ('findstr "projectId" .firebaserc') do (
    set PROJECT_ID=%%i
    set PROJECT_ID=!PROJECT_ID:"=!
    set PROJECT_ID=!PROJECT_ID: =!
)

if "%PROJECT_ID%"=="" (
    echo âŒ Project ID non trouvÃ© dans .firebaserc
    exit /b 1
)

echo â„¹ï¸  Projet Firebase: %PROJECT_ID%

REM Basculer vers l'environnement
echo â„¹ï¸  Basculement vers l'environnement %ENVIRONMENT%...
firebase use "%ENVIRONMENT%" >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo âš ï¸  Environnement %ENVIRONMENT% non trouvÃ©, crÃ©ation...
    firebase use --add "%PROJECT_ID%" "%ENVIRONMENT%"
) else (
    echo âœ… Environnement %ENVIRONMENT% activÃ©
)

cd ..

REM Ã‰tape 4: Lancement de l'application
echo â„¹ï¸  Ã‰tape 4/4: Lancement de l'application...

cd "%FRONTEND_DIR%"

echo âœ… ğŸ‰ Initialisation terminÃ©e avec succÃ¨s!
echo.
echo ğŸ“‹ Prochaines Ã©tapes:
echo    ğŸŒ L'application va dÃ©marrer sur http://localhost:3000
echo    ğŸ”¥ Firebase est configurÃ© pour l'environnement: %ENVIRONMENT%
echo    ğŸ“± Ouvrez un autre terminal pour les commandes Firebase
echo.
echo ğŸš€ Lancement de l'application...
echo    Appuyez sur Ctrl+C pour arrÃªter
echo.

REM Lancer l'application
call npm run dev 