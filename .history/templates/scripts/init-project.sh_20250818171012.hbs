#!/bin/bash

# Script d'initialisation automatique pour {{project.name}}
# Usage: ./init-project.sh [environment]
# Exemple: ./init-project.sh dev

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
PROJECT_NAME="{{project.name}}"
FRONTEND_DIR="frontend"
BACKEND_DIR="backend"
DEFAULT_ENVIRONMENT="dev"

# Fonction d'affichage colorÃ©
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Fonction d'aide
show_help() {
    echo "ğŸš€ Script d'initialisation automatique pour $PROJECT_NAME"
    echo ""
    echo "Usage: $0 [environment]"
    echo ""
    echo "Arguments:"
    echo "  environment    Environnement Firebase Ã  utiliser (dev, staging, prod)"
    echo "                 Par dÃ©faut: $DEFAULT_ENVIRONMENT"
    echo ""
    echo "Exemples:"
    echo "  $0              # Utilise l'environnement par dÃ©faut (dev)"
    echo "  $0 dev         # Utilise l'environnement dev"
    echo "  $0 staging     # Utilise l'environnement staging"
    echo "  $0 prod        # Utilise l'environnement prod"
    echo ""
    echo "Ce script va:"
    echo "  1. Installer les dÃ©pendances frontend"
    echo "  2. VÃ©rifier la connexion Firebase"
    echo "  3. Configurer l'environnement Firebase"
    echo "  4. Lancer l'application en mode dÃ©veloppement"
}

# VÃ©rifier les arguments
ENVIRONMENT=${1:-$DEFAULT_ENVIRONMENT}

# Validation de l'environnement
if [[ ! "$ENVIRONMENT" =~ ^(dev|staging|prod)$ ]]; then
    print_error "Environnement invalide: $ENVIRONMENT"
    echo "Environnements valides: dev, staging, prod"
    exit 1
fi

# VÃ©rifier que nous sommes dans le bon rÃ©pertoire
if [[ ! -d "$FRONTEND_DIR" ]] || [[ ! -d "$BACKEND_DIR" ]]; then
    print_error "RÃ©pertoires $FRONTEND_DIR ou $BACKEND_DIR non trouvÃ©s"
    echo "Assurez-vous d'exÃ©cuter ce script depuis la racine du projet gÃ©nÃ©rÃ©"
    exit 1
fi

echo "ğŸš€ Initialisation automatique de $PROJECT_NAME"
echo "ğŸ“ Environnement: $ENVIRONMENT"
echo ""

# Ã‰tape 1: Installation des dÃ©pendances frontend
print_info "Ã‰tape 1/4: Installation des dÃ©pendances frontend..."
cd "$FRONTEND_DIR"

if [[ ! -f "package.json" ]]; then
    print_error "package.json non trouvÃ© dans $FRONTEND_DIR"
    exit 1
fi

print_info "Installation des dÃ©pendances npm..."
npm install

if [[ $? -eq 0 ]]; then
    print_success "DÃ©pendances frontend installÃ©es avec succÃ¨s"
else
    print_error "Ã‰chec de l'installation des dÃ©pendances frontend"
    exit 1
fi

cd ..

# Ã‰tape 2: VÃ©rification de Firebase CLI
print_info "Ã‰tape 2/4: VÃ©rification de Firebase CLI..."

if ! command -v firebase &> /dev/null; then
    print_error "Firebase CLI non installÃ©"
    echo "Installez-le avec: npm install -g firebase-tools"
    exit 1
fi

print_success "Firebase CLI dÃ©tectÃ©: $(firebase --version)"

# Ã‰tape 3: Configuration Firebase
print_info "Ã‰tape 3/4: Configuration Firebase..."

cd "$BACKEND_DIR"

# VÃ©rifier la connexion Firebase
print_info "VÃ©rification de la connexion Firebase..."
if ! firebase projects:list &> /dev/null; then
    print_warning "Utilisateur Firebase non connectÃ©"
    print_info "Connexion Ã  Firebase..."
    firebase login
fi

# VÃ©rifier que le projet existe
PROJECT_ID=$(grep -o '"projectId": "[^"]*"' .firebaserc | cut -d'"' -f4)
if [[ -z "$PROJECT_ID" ]]; then
    print_error "Project ID non trouvÃ© dans .firebaserc"
    exit 1
fi

print_info "Projet Firebase: $PROJECT_ID"

# Basculer vers l'environnement
print_info "Basculement vers l'environnement $ENVIRONMENT..."
if firebase use "$ENVIRONMENT" &> /dev/null; then
    print_success "Environnement $ENVIRONMENT activÃ©"
else
    print_warning "Environnement $ENVIRONMENT non trouvÃ©, crÃ©ation..."
    firebase use --add "$PROJECT_ID" "$ENVIRONMENT"
fi

cd ..

# Ã‰tape 4: Lancement de l'application
print_info "Ã‰tape 4/4: Lancement de l'application..."

cd "$FRONTEND_DIR"

print_success "ğŸ‰ Initialisation terminÃ©e avec succÃ¨s!"
echo ""
echo "ğŸ“‹ Prochaines Ã©tapes:"
echo "   ğŸŒ L'application va dÃ©marrer sur un port disponible (3000-3010)"
echo "   ğŸ”¥ Firebase est configurÃ© pour l'environnement: $ENVIRONMENT"
echo "   ğŸ“± Ouvrez un autre terminal pour les commandes Firebase"
echo ""
echo "ğŸš€ Lancement de l'application avec port dynamique..."
echo "   Appuyez sur Ctrl+C pour arrÃªter"
echo ""

# Lancer l'application avec port dynamique
npm run dev:dynamic 